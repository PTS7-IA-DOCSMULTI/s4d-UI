<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Titillium+Web:400,600,700">
        <link href="style.css" rel="stylesheet">
		<script src="https://unpkg.com/wavesurfer.js"></script>
    </head>
    <body>
        <div class="left-part">
            <div class="shadow block">
                <div class="header">
                    Dendrogramme
					<input type="text" id="value">
					<button id="send">send to python</button>
					<label id="res">res</label>
                </div>
                <div class="content elements" id="svg">
                </div>
            </div>
        </div>
        <div class="right-part">
            <div class="shadow block">
                <div class="header">
                    Visualisation noeud
                </div>
                <div class="content">
                    <div id="nodeInfo">
                       <h3 id="nodeName">Node name:</h3>
                       <h3>Segments:</h3>
                       <ul id="segList">

                       </ul> 
                    </div>                        
                </div>
            </div>
        </div>
        <div class="bottom-part">
            <div class="shadow block">
                <div class="header">
                    Timeline
                    <button onclick="playPause()">Play/Pause</button>
                    <button onclick="toggleMute()">Mute/Unmute</button>
                    <button onclick="stop()">Stop</button>
                    Zoom
                    <input id="slider" type="range" min="1" max="500" value="1" />
                    <span id=audioTime></span>
                </div>
                <div class="content">
					<div id="waveform"></div>
                </div>
            </div>
        </div>
        <script src="https://d3js.org/d3.v4.min.js"></script>
		<script>
			var wavesurfer = WaveSurfer.create({
				container: '#waveform',
				waveColor: 'violet',
				progressColor: 'purple',
                scrollParent: true

			});
			wavesurfer.load('./audio.wav');
            setInterval(displayTime, 500);

            function displayTime() {
                let text = secondsToHms(wavesurfer.getCurrentTime()) + " - " + secondsToHms(wavesurfer.getDuration());
                document.getElementById("audioTime").innerHTML = text;
            }

            //duration must be in second
            function secondsToHms(d) {
                d = Number(d);
                var h = Math.floor(d / 3600);
                var m = Math.floor(d % 3600 / 60);
                var s = Math.floor(d % 3600 % 60);
                return (h < 10 ? "0" + h : h) + ":" +
                        (m < 10 ? "0" + m : m) + ":" +
                        (s < 10 ? "0" + s : s);
            }

            function playPause() {
                wavesurfer.playPause();
            }

            function toggleMute() {
                wavesurfer.toggleMute();
            }

            function stop() {
                wavesurfer.stop();
            }

            var slider = document.querySelector('#slider');

            slider.oninput = function () {
              var zoomLevel = Number(slider.value);
              wavesurfer.zoom(zoomLevel);
            };

		</script>
        <script>
            // set the dimensions and margins of the graph
            var width = 335
            var height = 335
            
            // append the svg object to the body of the page
            var svg = d3.select("#svg")
            .append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(0,20)");  // bit of margin on the top = 20
            
            // read json data
            d3.json("./test.json", function(data) {
            var cluster = d3.cluster()
              .size([ width, height - 40]) // bit of margin on the bottom = 20
              .separation(function(a,b) {
                return 1;
              })
            
            var root = d3.hierarchy(data, function(d) {
                return d.children;
            });
            cluster(root);

            // Lien entre chaque noeuds
            svg.selectAll('path')
              .data( root.descendants().slice(1) )
              .enter()
              .append('path')
                // Not the best solution to do this, but it works
                .style("", function(d) {
                    changeNodesHeight(d);
                })
                .attr("d", function(d) {
                //Draw two lines to link parent and child 
                  return "M" + d.x + "," + d.y
                          + "L" + d.x + "," + d.parent.y
                          + "L" + d.parent.x + "," + d.parent.y;
                        })
                .style("fill", "transparent")
                .style("stroke-dasharray", function(d) {
                    return d.depth == 1 ? "5,5" : "0,0";
                })
                .style("stroke", "black")
                
            
            // Cercle Ã  chaque noeud
            svg.selectAll("g")
                .data(root.descendants())
                .enter()
                .append("g")
                .attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")"
                })
                .append("circle")
                  .attr("r", 7)
                  .style("fill", "#69b3a2")
                  .attr("stroke", "black")
                  .style("cursor", "pointer")
                  .style("stroke-width", 2)
                  .on("mouseover", mouseover)
                  .on("mouseout", mouseout)
                  .on("click", function(d) {
                    nodeClick(d)
                    })
            });

            function mouseover() {
                d3.select(this)
                    .attr("r",10)
                    .style("fill", "red")
            }

            function mouseout() {
                d3.select(this)
                    .attr("r",7)
                    .style("fill", "#69b3a2")
            }

            //display node information on right panel when a node is clicked
            function nodeClick(d) {
                document.getElementById("nodeName").innerHTML = "Node name: " + d.data.name;
                let segList = document.getElementById("segList");
                segList.innerHTML = "";
                segments = getLeaves(d);
                for(var i = 0; i < segments.length; i++) {
                    var li = document.createElement("li");
                    var seg = segments[i].data;
                    var text = document.createTextNode(seg.name + " [" + seg.start + " - " + seg.end + "]");
                    li.appendChild(text);
                    segList.appendChild(li);
                }
            }

            //return all segments linked to the node
            function getLeaves(node, result = []){
                if(!node.children || node.children.length === 0){
                    result.push(node);
                }else{
                    for(var i = 0; i < node.children.length; i++) {
                        result = getLeaves(node.children[i], result);
                    }                   
                }
                return result;
            }
            

            function changeNodesHeight(node) {
                graphHeight = height - 40;
                node.y = graphHeight - (node.data.height / 100 * graphHeight);
            }

        </script>   
        <script type="text/javascript" src="./brain.js"></script>		
    </body>
</html>